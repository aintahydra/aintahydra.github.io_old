<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>aintahydra - dont talk shit</title>
  <meta name="author" content="aintahydra">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="aintahydra - dont talk shit"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="aintahydra - dont talk shit" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">aintahydra - dont talk shit</a></h1>
  <h2><a href="/">They hey seemed to insist upon his being but a mere __daily breader__,&#34; who was trudging home to snatch a few hours&#39; sleep before hurrying off to catch the train to his work. -- _Horace W. C. Newte, The Square Mile, A Story of Ways and Means, 1908_</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-12-10T04:20:20.000Z"><a href="/2017/12/10/tpm-test-on-compute-stick/">2017-12-10</a></time>
      
      
  
    <h1 class="title"><a href="/2017/12/10/tpm-test-on-compute-stick/">tpm-test-on-compute-stick</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h1><p>Compute Stick running Ubuntu 17.10 <a href="https://www.intel.com/content/www/us/en/products/boards-kits/compute-stick/stk2mv64cc.html" target="_blank" rel="external">STK2mv64CC</a></p>
<ul>
<li>Intel(R) Core(TM) m5-6Y57 CPU @ 1.10GHz</li>
<li>Storage: 64GB SSD</li>
<li>Memory: LPDDR3-1866 4GB</li>
<li>Graphics: Integrated, (as Ubuntu recognizes) Intel® HD Graphics 515 (Skylake GT2)</li>
<li>Wireless: Intel® Wireless-AC 8260 + BT 4.2</li>
<li>TPM: 2.0</li>
<li>Trusted Extension Technology</li>
</ul>
<h1 id="Install-tpm2-tools"><a href="#Install-tpm2-tools" class="headerlink" title="Install tpm2-tools"></a>Install tpm2-tools</h1><pre><code>$ sudo apt install tpm2-tools
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  libsapi-utils libsapi0
The following NEW packages will be installed:
  libsapi-utils libsapi0 tpm2-tools
...
</code></pre><h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><h2 id="Check-opened-ports"><a href="#Check-opened-ports" class="headerlink" title="Check opened ports"></a>Check opened ports</h2><pre><code>$ netstat -utlpn
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:5355            0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:2323          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:2324          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -                   
...
</code></pre><p>It seems tpm software uses arounds 2321 ports. Here, 2323 and 2324 should be the tpm ports. Some code examples use 2321 for both of the platform port and the command port, while some use one for the platform port, and the other is the command port. The command port seems to use +1 port of the platform port. So, here 2323 must be the platform port and 2324 must be the command port. We will figure this out below by running a simple code snippet.</p>
<pre><code>$ journalctl | grep resourcemgr
... resourcemgr[3073]: Initializing device TCTI Interface
... resourcemgr[3073]: Initializing Resource Manager
... resourcemgr[3073]: maxActiveSessions = 64
... resourcemgr[3073]: gapMaxValue = 65535
... resourcemgr[3073]: socket created:  0x4
... resourcemgr[3073]: bind to IP address:port:  127.0.0.1:2324
... resourcemgr[3073]: Other CMD server listening to socket:  0x4
... resourcemgr[3073]: socket created:  0x5
... resourcemgr[3073]: bind to IP address:port:  127.0.0.1:2323
... resourcemgr[3073]: TPM CMD server listening to socket:  0x5
... resourcemgr[3073]: Starting SockServer (TPM CMD), socket: 0x5.
... resourcemgr[3073]: Starting SockServer (Other CMD), socket: 0x4.
</code></pre><h2 id="Value-listings"><a href="#Value-listings" class="headerlink" title="Value listings"></a>Value listings</h2><p>Listing up PCR values </p>
<pre><code>$ tpm2_listpcrs
Bank/Algorithm: TPM_ALG_SHA1(0x0004)
PCR_00:   ...

Bank/Algorithm: TPM_ALG_SHA256(0x000b)
PCR_00: ...
</code></pre><p>Listing up values defined in the non-volatile storage</p>
<pre><code>$ tpm2_nvlist 
11 NV indexes defined.

  0. NV Index: 0x1410001
  {
    Hash algorithm(nameAlg):11
     The Index attributes(attributes):0x26040014
     The size of the data area(dataSize):8
   }

  1. NV Index: 0x1410002
  ....
</code></pre><h2 id="Get-Random"><a href="#Get-Random" class="headerlink" title="Get Random"></a>Get Random</h2><pre><code>$ tpm2_getrandom -s 20 -o random.out
GetRandom succ...
byte size: 20
 0xE0 0x14 0xBB 0xA8 0xD5 0x58 0xA2 0x9B 0x95 0xF1 0xD9 0xFD 0x3B 0x52 0x7D 0x82 0xEF 0xD8 0xF3 0x75
</code></pre><h2 id="Get-hash"><a href="#Get-hash" class="headerlink" title="Get hash"></a>Get hash</h2><pre><code>$ cat &gt; ~/data.in
Hello World!

$ tpm2_hash -H n -g 0x0004 -I ~/data.in -o ~/hash.out -t ~/tk.out
hierarchyValue: 0x40000007

halg = 0x0004

tpm2_hash succ.

hash value(hex type): a0 b6 59 39 67 0b c2 c0 10 f4 d5 d6 a0 b3 e4 e4 59 0f b9 2b 

validation value(hex type): 

$ hexdump -C ~/hash.out 
00000000  14 00 a0 b6 59 39 67 0b  c2 c0 10 f4 d5 d6 a0 b3  |....Y9g.........|
00000010  e4 e4 59 0f b9 2b 00 00  00 00 00 00 00 00 00 00  |..Y..+..........|
00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
</code></pre><h2 id="testing-through-the-command-port"><a href="#testing-through-the-command-port" class="headerlink" title="testing through the command port"></a>testing through the command port</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">import sys</div><div class="line">import socket</div><div class="line">from socket import socket, AF_INET, SOCK_STREAM</div><div class="line"></div><div class="line">platformSock = socket(AF_INET, SOCK_STREAM)</div><div class="line">platformSock.connect((&apos;localhost&apos;, 2324))</div><div class="line"># Power on the TPM</div><div class="line">platformSock.send(&apos;\0\0\0\1&apos;)</div><div class="line"></div><div class="line">tpmSock = socket(AF_INET, SOCK_STREAM)</div><div class="line">tpmSock.connect((&apos;localhost&apos;, 2323))</div><div class="line"></div><div class="line"># TPM_SEND_COMMAND : defined at the tpm service (See the **Note below)</div><div class="line">tpmSock.send(&apos;\x00\x00\x00\x08&apos;)</div><div class="line"></div><div class="line"># BYTE Locality</div><div class="line">tpmSock.send(&apos;\x03&apos;)</div><div class="line"></div><div class="line"># UINT32 InBufferSize</div><div class="line"># Send # of bytes : 12 bytes (The size of the following commands - 2 + 4 + 4 + 2)</div><div class="line">tpmSock.send(&apos;\x00\x00\x00\x0c&apos;)</div><div class="line"></div><div class="line"># Start of : BYTE[InBufferSize] InBuffer</div><div class="line"># TPM_ST (Structure Tags)</div><div class="line"># TPM2_ST_NO_SESSIONS : (UINT16)(0x8001) - Table 19 @ TPM 2.0 Part 2 v01.38</div><div class="line"># command/response has no attached sessions</div><div class="line">#   and no authorizationSize/parameterSize value is present</div><div class="line">tpmSock.send(&apos;\x80\x01&apos;)</div><div class="line"></div><div class="line"># TPM_PS (Platform Specific)</div><div class="line"># TPM2_PS_VIRTUALIZATION : (UINT32)(0x0000000C) - Table 25 @ TPM 2.0 Part 2 v01.38</div><div class="line">tpmSock.send(&apos;\x00\x00\x00\x0c&apos;)</div><div class="line"></div><div class="line"># Start up ----------</div><div class="line"># TPM2_CC_Startup : (UINT32)(0x00000144) - Table 12 @ TPM 2.0 Part 2 v01.38</div><div class="line">tpmSock.send(&apos;\x00\x00\x01\x44&apos;)</div><div class="line"></div><div class="line"># TPM_SU (Startup Type)</div><div class="line"># TPM_SU_CLEAR : (UINT16) 0x0000 - Table 20 @ TPM 2.0 Part 2 v01.38</div><div class="line">tpmSock.send(&apos;\x00\x00&apos;)</div><div class="line"></div><div class="line"># End of : BYTE[InBufferSize] InBuffer</div><div class="line"></div><div class="line"># Receive the size of the response, the response, and 4 bytes of 0&apos;s</div><div class="line">outBuffer = tpmSock.recv(18)</div><div class="line">for b in outBuffer:</div><div class="line">    print &quot;%#x &quot; % ord(b)</div></pre></td></tr></table></figure>
<p>** Note:<br>The above code is from “A Practical Guide to TPM 2.0”. While the book does not tell where 0x00000008 is defined, IBM’s SW TPM implementation gave me some hints. In case of ibmtpm974, TPM_SEND_COMMAND is defined in TpmTcpProtocol.h:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/* ...</div><div class="line"> Most TPM</div><div class="line">   commands are enveloped using the TPM_SEND_COMMAND interface command. The parameters are as</div><div class="line">   indicated below. </div><div class="line">... */</div><div class="line">...</div><div class="line">#define TPM_SEND_COMMAND            8</div><div class="line">    // &#123;BYTE Locality, UINT32 InBufferSize, BYTE[InBufferSize] InBuffer&#125; -&gt;</div><div class="line">    //     &#123;UINT32 OutBufferSize, BYTE[OutBufferSize] OutBuffer&#125;</div></pre></td></tr></table></figure></p>
<p>The sent command is processed in tpm server, where<br>main() @ TpmCmds.c -&gt; StartTcpServer() @ TcpServerPosix.c -&gt; RegularCommandService() @ TcpServerPosix.c -&gt; TpmServer() in TcpServerPosix.c : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">...	    </div><div class="line">		  case TPM_SEND_COMMAND:</div><div class="line">		    ok = ReadBytes(s, (char*) &amp;locality, 1);</div><div class="line">		    if(!ok)</div><div class="line">			return TRUE;</div><div class="line">		    </div><div class="line">		    ok = ReadVarBytes(s, InputBuffer, &amp;length, MAX_BUFFER);</div><div class="line">		    if(!ok)</div><div class="line">			return TRUE;</div><div class="line">		    InBuffer.Buffer = (BYTE*) InputBuffer;</div><div class="line">		    InBuffer.BufferSize = length;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>In case of Intel, the command seems to be defined in tcti_socket.h of tpm2-tss:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">// Commands to send to OTHER port.</div><div class="line">#define MS_SIM_POWER_ON         1</div><div class="line">#define MS_SIM_POWER_OFF        2</div><div class="line">#define MS_SIM_TPM_SEND_COMMAND 8</div><div class="line">...</div></pre></td></tr></table></figure>
<p>and what is TCTI(TPM Command Transmission Interface):<br><img src="https://github.com/intel/tpm2-tss/blob/master/doc/TSS%20block%20diagram.png" alt="Architecture Diagram"></p>
<h1 id="Troubleshootings"><a href="#Troubleshootings" class="headerlink" title="Troubleshootings"></a>Troubleshootings</h1><h2 id="Failed-initialization"><a href="#Failed-initialization" class="headerlink" title="Failed initialization"></a>Failed initialization</h2><p>Sometimes it shows, </p>
<pre><code>$ tpm2_listpcrs
Resource Mgr, resMgr, failed initialization: 0x1.  Exiting...
</code></pre><p>Then, restart the resource manager service.</p>
<pre><code>$ sudo systemctl status tpm2-resourcemgr.service

$ systemctl status tpm2-resourcemgr.service 
● tpm2-resourcemgr.service - TPM resource manager daemon
   Loaded: loaded (/lib/systemd/system/tpm2-resourcemgr.service; disabled; vendo
....
</code></pre><p>but, still resourcemgr wouldn’t work. It seems resourcemgr was the legacy of previous version of the software stack. <strong>Software for TPM 1.2 (trousers, the libtpm.so, etc.) seem not working TPM2</strong></p>
<pre><code>$ resourcemgr 
Initializing device TCTI Interface
Resource Mgr, device TCTI, failed initialization: 0xa000a.  Exiting...
</code></pre><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://mhsamsal.wordpress.com/2014/12/11/how-to-enable-tpm-in-linux-communicate-with-it-and-check-the-pcr-values/" target="_blank" rel="external">https://mhsamsal.wordpress.com/2014/12/11/how-to-enable-tpm-in-linux-communicate-with-it-and-check-the-pcr-values/</a></li>
<li><a href="https://github.com/intel/tpm2-tools" target="_blank" rel="external">https://github.com/intel/tpm2-tools</a></li>
<li>how to use tpm 2 tools (Intel) - <a href="https://github.com/intel/tpm2-tools/wiki/How-to-use-tpm2-tools" target="_blank" rel="external">https://github.com/intel/tpm2-tools/wiki/How-to-use-tpm2-tools</a></li>
<li>TPM2 and Linux - <a href="https://blog.hansenpartnership.com/tpm2-and-linux/" target="_blank" rel="external">https://blog.hansenpartnership.com/tpm2-and-linux/</a></li>
<li>TPM 1.2 vs. 2.0 Features - <a href="http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11849.tpm-1-2-vs-2-0-features" target="_blank" rel="external">http://en.community.dell.com/techcenter/enterprise-client/w/wiki/11849.tpm-1-2-vs-2-0-features</a></li>
<li>IBM’s Trousers for TPM 2.0 - <a href="https://sourceforge.net/projects/ibmtpm20tss/?source=navbar" target="_blank" rel="external">https://sourceforge.net/projects/ibmtpm20tss/?source=navbar</a></li>
<li>An Introduction to programming the TPM - <a href="https://www.cylab.cmu.edu/tiw/slides/challener-TPM.pdf" target="_blank" rel="external">https://www.cylab.cmu.edu/tiw/slides/challener-TPM.pdf</a></li>
<li>A Practical Guide to TPM 2.0 </li>
<li>The TCTI Specification - <a href="https://trustedcomputinggroup.org/wp-content/uploads/TSS_TCTI_v1.0_r04_Public-Review.pdf" target="_blank" rel="external">https://trustedcomputinggroup.org/wp-content/uploads/TSS_TCTI_v1.0_r04_Public-Review.pdf</a></li>
<li>The SAPI Specification - <a href="https://trustedcomputinggroup.org/wp-content/uploads/TSS_SAPI_v1.1_r21_Public_Review.pdf" target="_blank" rel="external">https://trustedcomputinggroup.org/wp-content/uploads/TSS_SAPI_v1.1_r21_Public_Review.pdf</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-12-06T06:55:49.000Z"><a href="/2017/12/06/tpm-test-with-ibm-sw-tpm/">2017-12-06</a></time>
      
      
  
    <h1 class="title"><a href="/2017/12/06/tpm-test-with-ibm-sw-tpm/">tpm-test-with-ibm-sw-tpm</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Tried with IBM’s SW TPM</p>
<h3 id="Step-1-Download-necessary-files"><a href="#Step-1-Download-necessary-files" class="headerlink" title="Step 1: Download necessary files"></a>Step 1: Download necessary files</h3><ul>
<li>IBM’s Software TPM 2.0  (<a href="https://sourceforge.net/projects/ibmswtpm2/" target="_blank" rel="external">https://sourceforge.net/projects/ibmswtpm2/</a> )</li>
<li>IBM’s TPM 2.0 TSS ( <a href="https://sourceforge.net/projects/ibmtpm20tss/?source=typ_redirect" target="_blank" rel="external">https://sourceforge.net/projects/ibmtpm20tss/?source=typ_redirect</a> )</li>
</ul>
<h3 id="Step-2-Build-and-execute-the-SW-TPM"><a href="#Step-2-Build-and-execute-the-SW-TPM" class="headerlink" title="Step 2: Build and execute the SW TPM"></a>Step 2: Build and execute the SW TPM</h3><ol>
<li>Extract the downloaded tarball</li>
</ol>
<pre><code>$ ls
ibmtpm.doc  LICENSE  src  tpmvstudio
Install openssl 1.0.x (not 1.1.x)
</code></pre><ol>
<li>Build (it requires openssl version 1.0.x, not 1.1.x)</li>
</ol>
<pre><code>$ openssl
OpenSSL&gt; version
OpenSSL 1.0.2g  1 Mar 2016
OpenSSL&gt; quit

$ tar xvfz ibmtpm974.tar.gz
$ cd ibmtpm974
$ cd src; make
</code></pre><ol>
<li>Run</li>
</ol>
<pre><code>$ ./tpm_server
TPM command server listening on port 2321
Platform server listening on port 2322
</code></pre><h3 id="Step-3-Build-the-TSS"><a href="#Step-3-Build-the-TSS" class="headerlink" title="Step 3: Build the TSS"></a>Step 3: Build the TSS</h3><ol>
<li>Extract the downloaded tarball</li>
</ol>
<pre><code>$ ls
demo  ibmtss.doc  ibmtss.html  LICENSE  tpmutils  utils
</code></pre><ol>
<li>Build utilities</li>
</ol>
<pre><code>cd utils; make
</code></pre><p>then, check out the built executables</p>
<pre><code>$ find . -perm -111 -type f
./policypcr
./policyauthorize
...
</code></pre><p>Currently, it provides:</p>
<p>activatecredential<br>certify, certifycreation<br>changeeps, changepps<br>clear<br>clearcontrol<br>clockrateadjust, clockset<br>commit<br>contextload, contextsave<br>create<br>createek<br>createloaded<br>createprimary<br>dictionaryattacklockreset, dictionaryattackparameters<br>duplicate<br>eccparameters<br>ecephemeral<br>encryptdecrypt<br>eventextend<br>eventsequencecomplete<br>evictcontrol<br>flushcontext<br>getcapability<br>getcommandauditdigest<br>getrandom<br>getsessionauditdigest<br>gettime<br>hash<br>hashsequencestart<br>hierarchychangeauth, hierarchycontrol<br>hmac, hmacstart<br>imaextend<br>import<br>importpem<br>libtss.so.0.1<br>load, loadexternal<br>makecredential<br>makeman.sh<br>ntc2getconfig, ntc2lockconfig, ntc2preconfig<br>nvcertify, nvchangeauth, nvdefinespace, nvextend, nvglobalwritelock, nvincrement<br>nvread, nvreadlock, nvreadpublic, nvsetbits, nvundefinespace, nvundefinespacespecial, nvwrite, nvwritelock<br>objectchangeauth<br>pcrallocate, pcrevent, pcrextend, pcrread, pcrreset<br>policyauthorize, policyauthorizenv, policyauthvalue, policycommandcode, policycountertimer, policycphash, policygetdigest, policymaker, policymakerpcr, policynv, policynvwritten, policyor, policypassword, policypcr, policyrestart, policysecret, policysigned, policytemplate, policyticket<br>powerup<br>quote<br>readclock<br>readpublic<br>reg.sh<br>returncode<br>rewrap<br>rsadecrypt, rsaencrypt<br>sequencecomplete, sequenceupdate<br>setprimarypolicy<br>shutdown<br>sign<br>signapp<br>startauthsession<br>startup<br>stirrandom<br>timepacket<br>unseal<br>verifysignature<br>writeapp</p>
<p>Also there are scripts under ./regtests/<br>testsalt.sh, testpolicy.sh, testunseal.sh<br>testbind.sh, testencsession.sh, testecc.sh<br>testaes.sh, testrsa.sh, testchangeauth.sh<br>initkeys.sh, testda.sh, testcontext.sh<br>testpolicy138.sh, testpcr.sh, teststorage.sh<br>testchangeseed.sh, testhmacsession.sh, testnv.sh<br>testcredential.sh, testrng.sh, testclocks.sh<br>inittpm.sh, testsign.sh, testattest.sh<br>testshutdown.sh, testprimary.sh, testhmac.sh<br>testaes138.sh, testnvpin.sh, testhierarchy.sh<br>testdup.sh, testcreateloaded.sh, testevict.sh</p>
<h3 id="Step-4-Power-up-and-start-the-SW-TPM"><a href="#Step-4-Power-up-and-start-the-SW-TPM" class="headerlink" title="Step 4: Power up and start the SW TPM"></a>Step 4: Power up and start the SW TPM</h3><p>Power up and start  up commands are required.</p>
<p>(In the TSS/utils directory,)</p>
<pre><code>$ ./powerup
</code></pre><p>(If you already have started the tpm_server above, you will see this,)</p>
<pre><code>...
Client accepted
Platform server listening on port 2322
Start the SW TPM
</code></pre><p>(In the TSS/utils directory,)</p>
<pre><code>$ ./startup
</code></pre><p>(the you will see,)</p>
<pre><code>Client accepted
TPM command server listening on port 2321
</code></pre><h3 id="Step-5-Test-functions"><a href="#Step-5-Test-functions" class="headerlink" title="Step 5: Test functions"></a>Step 5: Test functions</h3><p>Generate random bytes</p>
<pre><code>$ ./getrandom -by 4
 randomBytes length 4
 12 5c da 46
</code></pre><h3 id="Step-6-Build-demo"><a href="#Step-6-Build-demo" class="headerlink" title="Step 6: Build demo"></a>Step 6: Build demo</h3><p>Move into the demo directory</p>
<pre><code>$ ls
admin.php     halgsha256.inc    keycreate.php    makefilesha1_dev  pcr.php
block.png     handles.php       makefile         navdev.html       quote.php
demo.css      ibm.png           makefile-common  nav.html          sign.php
footer.html   IBM-TSS-Demo.doc  makefile_dev     nv.php            unseal.php
halgsha1.inc  index.php         makefilesha1     nvram.php
</code></pre><p>Prepare the www directory</p>
<pre><code>$ sudo mkdir -p /var/www/html/tpm2
$ sudo chmod 777 /var/www/html/tpm2
</code></pre><p>Make (there are several makefiles for different options, but here I use the one with SHA256 and SW TPM options):</p>
<p>$ make</p>
<p>Install necessary packages</p>
<pre><code>$ sudo apt install php php-dev
</code></pre><p>Move to the webroot and launch the a webserver</p>
<pre><code>$ cd /var/www/html
</code></pre><p>Start a web server at your convenience. I tried it with python’s SimpleHTTPServer module first, but it couldn’t render the php page. So, I tried it again with php web server:</p>
<pre><code>$ php -S 127.0.0.1:8000 -t .
PHP 7.0.22-0ubuntu0.16.04.1 Development Server started ...
Listening on http://127.0.0.1:8000
Document root is /var/www/html
Press Ctrl-C to quit.
[Wed Dec  6 03:20:19 2017] 127.0.0.1:57810 [200]: /tpm2/index.php
[Wed Dec  6 03:20:19 2017] 127.0.0.1:57812 [200]: /tpm2/demo.css
[Wed Dec  6 03:20:19 2017] 127.0.0.1:57814 [200]: /tpm2/ibm.png
[Wed Dec  6 03:20:19 2017] 127.0.0.1:57816 [200]: /tpm2/block.png
[Wed Dec  6 03:20:24 2017] 127.0.0.1:57808 Invalid request (Unexpected EOF)
Access to the demo home using iceweasel and some questions
</code></pre><p>Then execute a browser and go to <a href="http://localhost:8000/tpm2/index.php" target="_blank" rel="external">http://localhost:8000/tpm2/index.php</a></p>
<p><img src="./images/tss-demo-page.png" alt="web page"></p>
<h3 id="Step-7-Run-the-demo"><a href="#Step-7-Run-the-demo" class="headerlink" title="Step 7: Run the demo"></a>Step 7: Run the demo</h3><p>The demo is quite easy to follow. The document (ibmtss.doc) included in the tarball directs well what should be done.<br>These are what I found walking through the demo:</p>
<p>(1) a bug in keycreate.php<br>I found a small bug in demo, though. Line 82 of demo/keycreate.php has to be</p>
<pre><code>$retval = 0
</code></pre><p>instead of</p>
<pre><code>$retval == 0
</code></pre><p>The version I have is ibmtss1045, realeased on 17 Jul 2017.</p>
<p>** I reported this to the community, and it is going to be fixed:<br><img src="./images/KenGoldman.png" alt="mail"></p>
<p>(2) symlink to libtss.so<br>The demo needs libtss.so.0. You may need to create a symlink like:</p>
<pre><code>$ ln -s PATH_TO_TSS/imbtss1045/utils/libtss.so.0 /var/www/html/tpm2/libtss.so.0
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-23T00:03:30.000Z"><a href="/2017/11/23/latex-with-emacs/">2017-11-23</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/23/latex-with-emacs/">latex-with-emacs</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Install-necessary-packages"><a href="#Install-necessary-packages" class="headerlink" title="Install necessary packages"></a>Install necessary packages</h1><p>Install auctex (texmaker is another great option).</p>
<pre><code>$ apt install auctex texlive texlive-latex-extra 
</code></pre><h1 id="AUCTEX"><a href="#AUCTEX" class="headerlink" title="AUCTEX"></a>AUCTEX</h1><p>auctex should be loaded automatically. If not, start it manually by</p>
<pre><code>M-x tex-mode
</code></pre><p>or, add the followings to ~/.emacs:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(setq TeX-auto-save t)</div><div class="line">(setq TeX-parse-self t)</div><div class="line">(setq TeX-save-query nil)</div><div class="line">;(setq TeX-PDF-mode t)</div></pre></td></tr></table></figure></p>
<h1 id="For-USENIX-papers"><a href="#For-USENIX-papers" class="headerlink" title="For USENIX papers,"></a>For USENIX papers,</h1><ul>
<li><a href="https://www.usenix.org/legacy/events/sec06/cfp/submit-sample.tex" target="_blank" rel="external">latex sample</a></li>
<li><a href="https://www.usenix.org/conferences/author-resources/paper-templates" target="_blank" rel="external">latex template</a></li>
</ul>
<h1 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h1><p>for conveniences, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># SRC is the main latex file (file name only)</div><div class="line">SRC = paper</div><div class="line"></div><div class="line">all:	pdf</div><div class="line">	evince $&#123;SRC&#125;.pdf &amp;</div><div class="line"></div><div class="line"># rm -f $&#123;SRC&#125;.&#123;aux,bbl,blg,dvi,ent,log,pdf,ps&#125; doesn&apos;t work, weird</div><div class="line">clean:</div><div class="line">	rm -f *.aux; rm -f *.bbl; rm -f *.blg; rm -f *.dvi</div><div class="line">	rm -f *.ent; rm -f *.log; rm -f *.pdf; rm -f *.ps</div><div class="line"></div><div class="line">pdf:	dvi</div><div class="line">	dvipdf $&#123;SRC&#125;</div><div class="line"></div><div class="line">ps:	dvi</div><div class="line">	dvips -t a4 $&#123;SRC&#125;.dvi</div><div class="line"></div><div class="line">dvi:</div><div class="line">	latex $&#123;SRC&#125;</div><div class="line">	bibtex $&#123;SRC&#125;</div><div class="line">	latex $&#123;SRC&#125;</div><div class="line">	latex $&#123;SRC&#125;</div></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-10T06:39:56.000Z"><a href="/2017/11/10/xpath-syntax/">2017-11-10</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/10/xpath-syntax/">xpath-syntax</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><p>Each of five elements in the following is a node:</p>
<pre><code>&lt;body style=&quot;peachy&quot; class=&quot;top&quot;&gt;  wassup &lt;/body&gt;
</code></pre><p>A node has a type. Types are:</p>
<table>
<thead>
<tr>
<th>Node name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>root</td>
<td>xml itself</td>
</tr>
<tr>
<td>element</td>
<td>tag</td>
</tr>
<tr>
<td>attribute</td>
<td>attribute</td>
</tr>
<tr>
<td>text</td>
<td>tag content</td>
</tr>
<tr>
<td>namespace</td>
<td>a tag starts with ‘xmlns’</td>
</tr>
<tr>
<td>processing-instruction</td>
<td>a tag starts with ‘&lt;?’ </td>
</tr>
<tr>
<td>comment</td>
<td>as it says</td>
</tr>
</tbody>
</table>
<h1 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h1><h2 id="an-example-XML"><a href="#an-example-XML" class="headerlink" title="an example XML"></a>an example XML</h2><p>here’s an example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line"></div><div class="line">&lt;bookstore&gt;</div><div class="line"></div><div class="line">&lt;book&gt;</div><div class="line">  &lt;title lang=&quot;en&quot;&gt;Harry Potter&lt;/title&gt;</div><div class="line">  &lt;price&gt;29.99&lt;/price&gt;</div><div class="line">&lt;/book&gt;</div><div class="line"></div><div class="line">&lt;book&gt;</div><div class="line">  &lt;title lang=&quot;en&quot;&gt;Learning XML&lt;/title&gt;</div><div class="line">  &lt;price&gt;39.95&lt;/price&gt;</div><div class="line">&lt;/book&gt;</div><div class="line"></div><div class="line">&lt;/bookstore&gt;</div></pre></td></tr></table></figure>
<h2 id="elements"><a href="#elements" class="headerlink" title="elements"></a>elements</h2><p>All of the <bookstore><book> elements:</book></bookstore></p>
<pre><code>bookstore//book
</code></pre><p>All <book> elements:</book></p>
<pre><code>//book
</code></pre><p>Find the first <book> element:</book></p>
<pre><code>/bookstore/book[1]
</code></pre><p>Find <book> elements with a search condition:</book></p>
<pre><code>/bookstore/book[price&gt;30.00]
</code></pre><p>All the elements under <bookstore>:</bookstore></p>
<pre><code>//
</code></pre><h2 id="attribute-node"><a href="#attribute-node" class="headerlink" title="attribute node"></a>attribute node</h2><p>Other nodes than element nodes reqiures the ‘@’ symbol,</p>
<p>All the ‘lang’ nodes:</p>
<pre><code>//@lang
</code></pre><p>All the tags that has the lang attribute:</p>
<pre><code>//title[@lang]
</code></pre><h2 id="text-node"><a href="#text-node" class="headerlink" title="text node"></a>text node</h2><p>All text nodes exist within the (tag) element nodes. Therefore, it must start with an element node. For example, to get the text of <title> tags:</title></p>
<pre><code>//title/text()
</code></pre><p>Texts of all tags:</p>
<pre><code>//text()
</code></pre><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li>XPath Tutorial: <a href="https://www.w3schools.com/xml/xpath_intro.asp" target="_blank" rel="external">https://www.w3schools.com/xml/xpath_intro.asp</a></li>
<li>Test: <a href="http://www.xpathtester.com/xpath" target="_blank" rel="external">http://www.xpathtester.com/xpath</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-08T05:11:30.000Z"><a href="/2017/11/08/wrting-python-crawlers/">2017-11-08</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/08/wrting-python-crawlers/">wrting-python-crawlers</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Install-required-packages"><a href="#Install-required-packages" class="headerlink" title="Install required packages"></a>Install required packages</h1><pre><code>$ sudo apt install python-pip
$ pip scrapy lxml
</code></pre><h1 id="Create-a-project"><a href="#Create-a-project" class="headerlink" title="Create a project"></a>Create a project</h1><pre><code>$ scrapy startproject crawling_apt
$  tree crawling_apt/
crawling_apt/
├── crawling_apt ( name of this project0)
│   ├── __init__.py
│   ├── items.py
│   ├── middlewares.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       └── __init__.py
└── scrapy.cfg
</code></pre><p>Now a crawler can be written under the ‘spider’ folder, like:</p>
<pre><code>$ cd crawling_apt
$ EDIT crawling_apt/spiders/AHoppingSpider.py
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment">#-*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># to execute</span></div><div class="line"><span class="comment"># ~/python/mycrawler/crawling_apt$ scrapy crawl ahopper</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"><span class="keyword">from</span> listitem <span class="keyword">import</span> InfoListItem</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AHoppingSpider</span><span class="params">(scrapy.Spider)</span>:</span></div><div class="line">    name = <span class="string">"ahopper"</span></div><div class="line">    allowed_domains = [<span class="string">"apt2you.com"</span>]</div><div class="line">    start_urls = [</div><div class="line">        <span class="string">"https://www.apt2you.com/"</span>,</div><div class="line">    ]</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></div><div class="line">        <span class="keyword">return</span> scrapy.Request(</div><div class="line">            url = <span class="string">"https://www.apt2you.com/houseSaleSimpleInfo.do"</span>,</div><div class="line">            callback = self.parse_notice</div><div class="line">        )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_notice</span><span class="params">(self, response)</span>:</span></div><div class="line"></div><div class="line">        <span class="comment">## just save the whole HTML page to a local file </span></div><div class="line">        <span class="comment">#page = response.url.split("/")[-2]</span></div><div class="line">        <span class="comment">#filename = 'ahopper-%s.html' % page </span></div><div class="line">        <span class="comment">#with open(filename, 'wb') as f :</span></div><div class="line">        <span class="comment">#    f.write(response.body)</span></div><div class="line"></div><div class="line">        rows = response.xpath(<span class="string">'//table[@class="tbl_default sortable"]/tbody/tr'</span>)</div><div class="line"></div><div class="line">        items = []</div><div class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> rows:</div><div class="line">            item = InfoListItem()</div><div class="line">            </div><div class="line">            area = row.xpath(<span class="string">'td[1]/text()'</span>).extract()</div><div class="line">            <span class="comment"># aptname, constructor, applydates below are the same type</span></div><div class="line">            aptname = row.xpath(<span class="string">'td[2]//u/text()'</span>).extract()</div><div class="line">            constructor = row.xpath(<span class="string">'td[3]/text()'</span>).extract()</div><div class="line">            applydates = row.xpath(<span class="string">'td[4]/text()'</span>).extract()</div><div class="line">            <span class="comment"># now area is a list of unicode. type(area) is 'list'</span></div><div class="line"></div><div class="line">            strarea = area[<span class="number">0</span>].encode(<span class="string">"UTF-8"</span>)</div><div class="line">            <span class="comment"># now strarea is a string contains UTF-8 characters</span></div><div class="line">            straptname = aptname[<span class="number">0</span>].encode(<span class="string">"UTF-8"</span>)</div><div class="line">            strconstructor = constructor[<span class="number">0</span>].encode(<span class="string">"UTF-8"</span>)</div><div class="line">            strapplydates = <span class="string">""</span>.join(applydates[<span class="number">0</span>].encode(<span class="string">"UTF-8"</span>).split())</div><div class="line"></div><div class="line">	    tup = (strarea, straptname, strconstructor, strapplydates)</div><div class="line">                                       </div><div class="line">            items.append(tup)</div><div class="line"></div><div class="line">        report = str()</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> items:</div><div class="line">            <span class="keyword">if</span> (<span class="string">u'XX'</span>.encode(<span class="string">"UTF-8"</span>) == i[<span class="number">0</span>]) :</div><div class="line">                <span class="comment"># <span class="doctag">NOTE:</span> u'XX' is a unicode, not a string.</span></div><div class="line">                <span class="comment"># so it must be converted to a UTF-8 character string,</span></div><div class="line">		<span class="comment"># before compared to strarea</span></div><div class="line"></div><div class="line">                <span class="comment"># for debugging it could be printed on the screen, like below</span></div><div class="line">                <span class="keyword">print</span> <span class="string">", "</span>.join(i)</div><div class="line">                report = report + <span class="string">", "</span>.join(i) + <span class="string">"\n"</span></div><div class="line">                </div><div class="line">            <span class="keyword">else</span> :</div><div class="line">                <span class="keyword">pass</span>    </div><div class="line"></div><div class="line">        page = response.url.split(<span class="string">"/"</span>)[<span class="number">-2</span>]</div><div class="line">        filename = <span class="string">'ahopper-%s.html'</span> % page </div><div class="line">        <span class="keyword">with</span> open(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f :</div><div class="line">            f.write(report)</div></pre></td></tr></table></figure>
<p>Execute it:</p>
<pre><code>$ scrapy crawl ahopper
</code></pre><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><h2 id="1-Scrapy-shell"><a href="#1-Scrapy-shell" class="headerlink" title="1. Scrapy shell"></a>1. Scrapy shell</h2><p>Fetch a page:</p>
<pre><code>$ scrapy shell &apos;http://DOMAIN/page/1/&apos;
</code></pre><p>Select a CSS element (ex) ‘title’), and get its text:</p>
<pre><code>&gt;&gt;&gt; response.css(&apos;title&apos;)
[&lt;Selector xpath=&apos;descendant-or-self::title&apos; data=&apos;&lt;title&gt;Quotes to Scrape&lt;/title&gt;&apos;&gt;
&gt;&gt;&gt; response.css(&apos;title&apos;).extract()
[&apos;&lt;title&gt;Quotes to Scrape&lt;/title&gt;&apos;]
&gt;&gt;&gt; response.css(&apos;title::text&apos;).extract()
[&apos;Quotes to Scrape&apos;]
</code></pre><p>we can use regular expressions:</p>
<pre><code>&gt;&gt;&gt; response.css(&apos;title::text&apos;).re(r&apos;Quotes.*&apos;)
[&apos;Quotes to Scrape&apos;]
&gt;&gt;&gt; response.css(&apos;title::text&apos;).re(r&apos;Q\w+&apos;)
[&apos;Quotes&apos;]
&gt;&gt;&gt; response.css(&apos;title::text&apos;).re(r&apos;(\w+) to (\w+)&apos;)
[&apos;Quotes&apos;, &apos;Scrape&apos;]
</code></pre><p>XPath is supported:</p>
<pre><code>&gt;&gt;&gt; response.xpath(&apos;//title&apos;)
[&lt;Selector xpath=&apos;//title&apos; data=&apos;&lt;title&gt;Quotes to Scrape&lt;/title&gt;&apos;&gt;]
&gt;&gt;&gt; response.xpath(&apos;//title/text()&apos;).extract_first()
&apos;Quotes to Scrape&apos;
</code></pre><h1 id="Possible-errors"><a href="#Possible-errors" class="headerlink" title="Possible errors:"></a>Possible errors:</h1><pre><code>[scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)
</code></pre><p>then set the following in the settings.py file</p>
<pre><code>ROBOTSTXT_OBEY=false
</code></pre><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://doc.scrapy.org/en/latest/intro/tutorial.html" target="_blank" rel="external">https://doc.scrapy.org/en/latest/intro/tutorial.html</a></li>
<li><a href="http://www.olafdietsche.de/2015/04/05/extracting-table-data-with-scrapy" target="_blank" rel="external">http://www.olafdietsche.de/2015/04/05/extracting-table-data-with-scrapy</a></li>
<li><a href="http://vnthf.logdown.com/posts/2016/03/18/650623" target="_blank" rel="external">http://vnthf.logdown.com/posts/2016/03/18/650623</a></li>
<li>Scrapy.Items: <a href="https://doc.scrapy.org/en/latest/topics/items.html" target="_blank" rel="external">https://doc.scrapy.org/en/latest/topics/items.html</a></li>
</ul>
<h1 id="ETC"><a href="#ETC" class="headerlink" title="ETC"></a>ETC</h1><ul>
<li>the example code above: <a href="./data/mycrawler.tar.gz">code</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-11-07T22:14:12.000Z"><a href="/2017/11/08/emacs-etag/">2017-11-08</a></time>
      
      
  
    <h1 class="title"><a href="/2017/11/08/emacs-etag/">emacs-etag</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Generating-TAGS"><a href="#Generating-TAGS" class="headerlink" title="Generating TAGS"></a>Generating TAGS</h1><pre><code>$ etags *.[chCH]
</code></pre><p>or</p>
<pre><code>$ find . -name &quot;*.[chCH]&quot; -print | etags -
</code></pre><h1 id="Shortcuts-for-Navigation"><a href="#Shortcuts-for-Navigation" class="headerlink" title="Shortcuts for Navigation"></a>Shortcuts for Navigation</h1><table>
<thead>
<tr>
<th>Key</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>M-. RET</td>
<td>go to the definition</td>
</tr>
<tr>
<td>C-u M-.</td>
<td>(next match)</td>
</tr>
<tr>
<td>M-*</td>
<td>go back to the previous position</td>
</tr>
<tr>
<td>M-x tags-search</td>
<td>RE-search</td>
</tr>
<tr>
<td>M-x tags-query-replace</td>
<td>as it says</td>
</tr>
<tr>
<td>M-,</td>
<td>resume search or replace</td>
</tr>
<tr>
<td>M-x tags-apropos</td>
<td>list all tags match a RE</td>
</tr>
<tr>
<td>M-x list-tags</td>
<td>list all tags defined in the file</td>
</tr>
</tbody>
</table>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>I am using tboot-1.9.6 code that can be downloaded at <a href="https://sourceforge.net/projects/tboot/" target="_blank" rel="external">https://sourceforge.net/projects/tboot/</a></p>
<h2 id="Generate-a-tag-table"><a href="#Generate-a-tag-table" class="headerlink" title="Generate a tag table"></a>Generate a tag table</h2><pre><code>$ pwd
/home/xxxxxx/etags/tboot-1.9.6
$ find -H ~/Downloads/tboot-1.9.6 -name &apos;*.[csSh]&apos; | etags -
</code></pre><p>etag create a tag table (file name: TAGS) in current directory</p>
<pre><code>$ head -n 5 TAGS
/home/xxxxxx/Downloads/tboot-1.9.6/lcptools/poldata.c,226
#define PRINT 42,1745
size_t get_policy_data_size(53,2011
bool verify_policy_data(65,2405
...
</code></pre><h2 id="source-navigate"><a href="#source-navigate" class="headerlink" title="source navigate"></a>source navigate</h2><ul>
<li>open a file with emacs. (for example,  ~/Downloads/tboot-1.9.6/tboot/common/tboot.c is opened here)</li>
<li><p>place the cursor on a function and (M-.), then the minibuffer will show a message, like:</p>
<p>  Find tag: (default txt_verify_platform)</p>
</li>
</ul>
<p><img src="/images/tboot-src-ex1.png" alt="finding-a-tag"></p>
<ul>
<li><p>press <enter>, then emacs will ask the location of TAG table</enter></p>
<p>  Visit tags table (default TAGS): ~/Downloads/tboot-1.9.6/tboot/common/</p>
</li>
<li><p>tell where is the tag table (~/etags/tboot-1.9.6), then it will show the first match</p>
<ul>
<li>Now you can go to the next match (C-u M-.) or the previous match (M-*)</li>
</ul>
</li>
</ul>
<h1 id="emacs-with-cscope"><a href="#emacs-with-cscope" class="headerlink" title="emacs with cscope"></a>emacs with cscope</h1><h2 id="install-cscope"><a href="#install-cscope" class="headerlink" title="install cscope"></a>install cscope</h2><pre><code>$ sudo apt install cscope xcscope-el
</code></pre><p>add the following line to ~/.emacs and ~/.emacs.d/init.el</p>
<pre><code>(require &apos;xcscope&apos;)
</code></pre><h2 id="open-a-file-with-emacs-and-generate-cscope-DB"><a href="#open-a-file-with-emacs-and-generate-cscope-DB" class="headerlink" title="open a file with emacs, and generate cscope DB"></a>open a file with emacs, and generate cscope DB</h2><p>Open a source file, and enter</p>
<pre><code>M-x cscope-index-file
</code></pre><p>after let it know the source code location, it will create  cscope.out and cscope.files will be created then.</p>
<pre><code>$ cscope -bkqR
$ ls
CHANGELOG  cscope.in.out  docs      lcptools     README     test-patches
Config.mk  cscope.out     include   lcptools-v2  tboot      txt-test
COPYING    cscope.po.out  lcp-gen2  Makefile     tb_polgen  utils
</code></pre><h2 id="Browse-source-codes"><a href="#Browse-source-codes" class="headerlink" title="Browse source codes"></a>Browse source codes</h2><p>Place the cursor on a function, and move to the definition by (C-c s d)</p>
<p>Other shortcuts are:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>action</th>
</tr>
</thead>
<tbody>
<tr>
<td>C-c s s</td>
<td>Find symbol</td>
<td></td>
</tr>
<tr>
<td>C-c s d</td>
<td>Find global definition</td>
<td></td>
</tr>
<tr>
<td>C-c s g</td>
<td>Find global definition (alternate binding)</td>
<td></td>
</tr>
<tr>
<td>C-c s G</td>
<td>Find global definition without prompting</td>
<td></td>
</tr>
<tr>
<td>C-c s c</td>
<td>Find functions calling a function</td>
<td></td>
</tr>
<tr>
<td>C-c s C</td>
<td>Find called functions (list functions called from a function)</td>
<td></td>
</tr>
<tr>
<td>C-c s t</td>
<td>Find text string</td>
<td></td>
</tr>
<tr>
<td>C-c s e</td>
<td>Find egrep pattern</td>
<td></td>
</tr>
<tr>
<td>C-c s f</td>
<td>Find a file</td>
<td></td>
</tr>
<tr>
<td>C-c s i</td>
<td>Find files #including a file</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref."></a>Ref.</h1><ul>
<li><a href="https://www.emacswiki.org/emacs/EmacsTags" target="_blank" rel="external">https://www.emacswiki.org/emacs/EmacsTags</a><br><a href="https://www.emacswiki.org/emacs/CScopeAndEmacs" target="_blank" rel="external">https://www.emacswiki.org/emacs/CScopeAndEmacs</a></li>
<li><a href="https://techtooltip.wordpress.com/2012/01/06/how-to-integrate-emacs-cscope-to-browse-linux-kernel-source-code/" target="_blank" rel="external">https://techtooltip.wordpress.com/2012/01/06/how-to-integrate-emacs-cscope-to-browse-linux-kernel-source-code/</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-12-07T13:39:32.000Z"><a href="/2015/12/07/develop-with-emacs/">2015-12-07</a></time>
      
      
  
    <h1 class="title"><a href="/2015/12/07/develop-with-emacs/">develop-with-emacs</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h1><pre><code>$ emacs test.cpp
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#include &lt;iostream&gt;</div><div class="line"></div><div class="line">using namespace std;</div><div class="line"></div><div class="line">int main (void)</div><div class="line">&#123;</div><div class="line">  cout &lt;&lt; &quot;Hello World&quot;;</div><div class="line">  return;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile</p>
<ul>
<li>after saving (C-x C-s) the file, input (M-x compile)</li>
<li>then you will see the minibuffer appears below, showing “make -k”</li>
<li>input (C-a) and then (C-k) (move up front in that line + kill afterwards)</li>
<li>input (g++ -o test test.cpp)</li>
<li>then another buffer is created and shows a compile error</li>
</ul>
<p>Debug</p>
<ul>
<li>input (C-x `) then the cursor will be moved to where caused the error<ul>
<li>Repeat input (C-x `) and fix error until all the compile errors go away</li>
</ul>
</li>
<li>after debugging, save the file (C-x C-s) and compile it again (M-x compile)</li>
</ul>
<p>Run</p>
<ul>
<li>After compilation, (optionally) move to the other buffer (C-x o), and execute a shell by (M-x shell), and input (./test)</li>
</ul>
<h1 id="gdb-with-emacs"><a href="#gdb-with-emacs" class="headerlink" title="gdb with emacs"></a>gdb with emacs</h1><pre><code>$ emacs divzero.cpp
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#include &lt;iostream&gt;</div><div class="line"></div><div class="line">using namespace std;</div><div class="line"></div><div class="line">int div(int a, int b)</div><div class="line">&#123;</div><div class="line">  return (a / b);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main (void)</div><div class="line">&#123;</div><div class="line">  int x, y;</div><div class="line"></div><div class="line">  x = 4, y = 2;</div><div class="line">  cout &lt;&lt; div(x, y);</div><div class="line"></div><div class="line">  x = 4, y = 0;</div><div class="line">  cout &lt;&lt; div(x, y);</div><div class="line"></div><div class="line">  return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>compile it with -g option, like</p>
<pre><code>g++ -g -o divzero divzero.cpp
</code></pre><p>then it is compiled clean, but when you run it, it will be crashed</p>
<pre><code>$ ./divzero
Floating point exception (core dumped)
</code></pre><p>Run gdb with (M-x gdb), then it will show gdb in the other window.<br>Run it. Use “run (or r)”</p>
<pre><code>(gdb) run
Starting program: /home/ohpato/c_cpp/divzero
Program received signal SIGFPE, Arithmetic exception.
0x0000000000400754 in div (a=4, b=0) at divzero.cpp:7
7      return (a / b);
</code></pre><p>Also, in the other window, a small triangle should be appeared pointing out where the Arithmetic exception is caused.</p>
<p>Let’s backtrace it. Use “backtrace( or bt)”</p>
<pre><code>(gdb) bt
#0  0x0000000000400754 in div (a=4, b=0) at divzero.cpp:7
#1  0x00000000004007a7 in main () at divzero.cpp:18
</code></pre><p>It says the exception occurred when div() is called in main().<br>Set breakpoint at div(). Use “break(or br)”</p>
<pre><code>(gdb) break divzero.cpp:div
Breakpoint 7 at 0x400750: file divzero.cpp, line 7.
</code></pre><p>Now, let’s re run it</p>
<pre><code>(gdb) r
Starting program: /home/ohpato/c_cpp/divzero
Breakpoint 7, div (a=4, b=2) at divzero.cpp:7
7      return (a / b);
</code></pre><p>Go forward with “next (or n)” or (C-c C-n). Or “step (or s)” or (C-c C-s). Then, the small triangle in the other window should move along.  </p>
<p>After debugging,<br>Save (C-x C-s) -&gt; Compile (M-x compile) -&gt; Go to another buffer (C-x o) -&gt; Switch to gdb buffer (C-x b)</p>
<p>When the gdb buffer appears,<br>read the new file. Use “file”</p>
<pre><code>(gdb) file divzero
Reading symbols from divzero...done.
</code></pre><p>Clear breakpoints</p>
<pre><code>(gdb) clear
Deleted breakpoint 7
</code></pre><p>Run it.</p>
<pre><code>(gdb) r
Starting program: /home/ohpato/c_cpp/divzero
[Inferior 1 (process 1347) exited normally]
</code></pre><p>Looks good now.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:aintahydra.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/ETC/">ETC</a><small>1</small></li>
  
    <li><a href="/categories/TPM/">TPM</a><small>2</small></li>
  
    <li><a href="/categories/emacs/">emacs</a><small>3</small></li>
  
    <li><a href="/categories/python/">python</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/TAGS/">TAGS</a><small>1</small></li>
  
    <li><a href="/tags/TPM/">TPM</a><small>2</small></li>
  
    <li><a href="/tags/TSS/">TSS</a><small>1</small></li>
  
    <li><a href="/tags/Trusted-Platform-Module/">Trusted Platform Module</a><small>1</small></li>
  
    <li><a href="/tags/auctex/">auctex</a><small>1</small></li>
  
    <li><a href="/tags/compute-stick/">compute stick</a><small>1</small></li>
  
    <li><a href="/tags/crawler/">crawler</a><small>1</small></li>
  
    <li><a href="/tags/ctag/">ctag</a><small>1</small></li>
  
    <li><a href="/tags/emacs/">emacs</a><small>3</small></li>
  
    <li><a href="/tags/etag/">etag</a><small>1</small></li>
  
    <li><a href="/tags/gdb/">gdb</a><small>1</small></li>
  
    <li><a href="/tags/latex/">latex</a><small>1</small></li>
  
    <li><a href="/tags/python/">python</a><small>1</small></li>
  
    <li><a href="/tags/scrapy/">scrapy</a><small>1</small></li>
  
    <li><a href="/tags/xpath/">xpath</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 aintahydra
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
